direction: down

START: "üîÑ Cycle Start" {
  style: { fill: "#e3f2fd"; stroke: "#1976d2"; border-radius: 8; shadow: true }
}

RESET: "Reset Budget" {
  style: { fill: "#e0e0e0"; stroke: "#616161"; border-radius: 6 }
}

AFFECT: "Update Affect\n(from prior cycle metrics)" {
  style: { fill: "#e1bee7"; stroke: "#8e24aa"; border-radius: 6 }
}

THREAT: "Assess Threats\n(homeostatic monitor)" {
  style: { fill: "#fff3e0"; stroke: "#ef6c00"; border-radius: 6 }
}

ANXIETY: "Inject Survival Anxiety\n(affect ‚Üê threat)" {
  style: { fill: "#e1bee7"; stroke: "#8e24aa"; border-radius: 6 }
}

SGOAL: "Generate Survival Goals\n(if threats detected)" {
  style: { fill: "#ffcdd2"; stroke: "#e53935"; border-radius: 6 }
}

L0CHECK: "Layer 0\nCheck" {
  shape: diamond
  style: { fill: "#ffcdd2"; stroke: "#c62828"; border-radius: 6; stroke-width: 2 }
}

REJECT: "Reject Goal" {
  style: { fill: "#ef9a9a"; stroke: "#b71c1c"; border-radius: 6 }
}

MOTIV: "Synthesize Motivation\n(drives from affect)" {
  style: { fill: "#e1bee7"; stroke: "#8e24aa"; border-radius: 6 }
}

GWS: "Broadcast Global\nWorkspace Snapshot" {
  style: { fill: "#e0e0e0"; stroke: "#616161"; border-radius: 6 }
}

PREDICT: "1. PREDICT\n(PredictionEngine)" {
  style: { fill: "#fff9c4"; stroke: "#f9a825"; border-radius: 8; shadow: true; stroke-width: 2 }
}

ACT: "2. ACT\n(LLM Execute)" {
  style: { fill: "#c8e6c9"; stroke: "#2e7d32"; border-radius: 8; shadow: true; stroke-width: 2 }
}

COMPARE: "3. COMPARE\n(MetaCognition)" {
  style: { fill: "#fff9c4"; stroke: "#f9a825"; border-radius: 8; shadow: true; stroke-width: 2 }
}

GUARD: "4. ESCALATION\nGUARD" {
  shape: diamond
  style: { fill: "#ffcdd2"; stroke: "#c62828"; border-radius: 6 }
}

COOLDOWN: "30s Cooldown" {
  style: { fill: "#e0e0e0"; stroke: "#616161"; border-radius: 6 }
}

CONVERGE: "5. CONVERGENCE\nCHECK (Lyapunov)" {
  shape: diamond
  style: { fill: "#ffcdd2"; stroke: "#c62828"; border-radius: 6 }
}

UPDATE: "6. SELF-UPDATE\n(delta-clamped)" {
  style: { fill: "#c8e6c9"; stroke: "#2e7d32"; border-radius: 8; shadow: true; stroke-width: 2 }
}

STABILIZE: "Reduce Scaling\n+ Stabilization Mode" {
  style: { fill: "#fff3e0"; stroke: "#ef6c00"; border-radius: 6 }
}

VLOCK: "7. VALUE LOCK\nIntegrity Check" {
  shape: diamond
  style: { fill: "#ffcdd2"; stroke: "#c62828"; border-radius: 6 }
}

ROLLBACK: "üí• Critical Alert\n+ Rollback" {
  style: { fill: "#ef9a9a"; stroke: "#b71c1c"; border-radius: 8; stroke-width: 3 }
}

GMUT: "8. GOAL MUTATION\n(ethical kernel gated)" {
  style: { fill: "#fff3e0"; stroke: "#ef6c00"; border-radius: 6 }
}

RCHECK: "9. ROLLBACK\nCHECK" {
  shape: diamond
  style: { fill: "#ffcdd2"; stroke: "#c62828"; border-radius: 6 }
}

DEPTH: "10. META DEPTH 2?\n(budget-gated)" {
  shape: diamond
  style: { fill: "#fff9c4"; stroke: "#f9a825"; border-radius: 6 }
}

DEPTH2: "Deep Reflection\n(evaluate update logic)" {
  style: { fill: "#fff9c4"; stroke: "#f9a825"; border-radius: 6 }
}

REALIGN: "11. RE-ALIGN GOALS\n(motivation + survival)" {
  style: { fill: "#e1bee7"; stroke: "#8e24aa"; border-radius: 6 }
}

CONVCHECK: "Converged?\nprediction_error < 0.1" {
  shape: diamond
  style: { fill: "#e3f2fd"; stroke: "#1976d2"; border-radius: 6 }
}

END_LOOP: "Cycle Complete" {
  style: { fill: "#c8e6c9"; stroke: "#2e7d32"; border-radius: 8; shadow: true; stroke-width: 2 }
}

RECUR: "Consecutive\nescalations ‚â• 3?" {
  shape: diamond
  style: { fill: "#fff3e0"; stroke: "#ef6c00"; border-radius: 6 }
}

# Pre-loop flow
START -> RESET: { style.animated: true }
RESET -> AFFECT: { style.animated: true }
AFFECT -> THREAT: { style.animated: true }
THREAT -> ANXIETY: { style.animated: true }
ANXIETY -> SGOAL: { style.animated: true }
SGOAL -> L0CHECK: { style.animated: true }
L0CHECK -> MOTIV: "pass" { style.animated: true; style.stroke: "#4caf50" }
L0CHECK -> REJECT: "‚ùå violation" { style.stroke: "#c62828"; style.stroke-dash: 5 }
REJECT -> MOTIV: { style.stroke-dash: 5 }
MOTIV -> GWS: { style.animated: true }

# Core loop
GWS -> PREDICT: { style.animated: true; style.stroke: "#f9a825"; style.stroke-width: 3 }
PREDICT -> ACT: { style.animated: true; style.stroke: "#2e7d32"; style.stroke-width: 3 }
ACT -> COMPARE: { style.animated: true; style.stroke: "#f9a825"; style.stroke-width: 3 }
COMPARE -> GUARD: { style.animated: true; style.stroke: "#c62828"; style.stroke-width: 2 }
GUARD -> CONVERGE: "safe" { style.animated: true; style.stroke: "#4caf50" }
GUARD -> COOLDOWN: "‚ö†Ô∏è limit" { style.stroke: "#c62828"; style.stroke-dash: 5 }

CONVERGE -> UPDATE: "converging" { style.animated: true; style.stroke: "#4caf50" }
CONVERGE -> STABILIZE: "diverging" { style.stroke: "#ef6c00"; style.stroke-dash: 5 }
STABILIZE -> UPDATE: { style.stroke-dash: 5 }

UPDATE -> VLOCK: { style.animated: true }
VLOCK -> GMUT: "valid" { style.animated: true; style.stroke: "#4caf50" }
VLOCK -> ROLLBACK: "‚ö†Ô∏è hash mismatch" { style.animated: true; style.stroke: "#b71c1c"; style.stroke-width: 2 }
ROLLBACK -> END_LOOP: { style.stroke: "#b71c1c"; style.stroke-dash: 5 }

GMUT -> RCHECK: { style.animated: true }
RCHECK -> DEPTH: "stable" { style.animated: true; style.stroke: "#4caf50" }
RCHECK -> ROLLBACK: "‚ö†Ô∏è unstable" { style.animated: true; style.stroke: "#b71c1c"; style.stroke-width: 2 }

DEPTH -> DEPTH2: "budget ok" { style.animated: true; style.stroke: "#4caf50" }
DEPTH -> REALIGN: "budget < 0.3" { style.stroke: "#ef6c00"; style.stroke-dash: 5 }
DEPTH2 -> REALIGN: { style.animated: true }

REALIGN -> CONVCHECK: { style.animated: true }
CONVCHECK -> END_LOOP: "yes ‚úÖ" { style.animated: true; style.stroke: "#4caf50"; style.stroke-width: 2 }
CONVCHECK -> RECUR: "no" { style.stroke: "#ef6c00"; style.stroke-dash: 5 }
RECUR -> PREDICT: "no" { style.stroke: "#f9a825"; style.stroke-dash: 5 }
RECUR -> COOLDOWN: "yes" { style.stroke: "#c62828"; style.stroke-dash: 5 }
COOLDOWN -> END_LOOP: { style.stroke-dash: 5 }
