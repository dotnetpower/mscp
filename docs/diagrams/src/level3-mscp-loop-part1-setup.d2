direction: down

title: "MSCP v4 Loop ‚Äî Part 1: Pre-Loop Setup & Core Processing" {
  style: { font-size: 18; bold: true }
}

START: "üîÑ Cycle Start" {
  style: { fill: "#e3f2fd"; stroke: "#1976d2"; border-radius: 8; shadow: true; font-size: 14 }
}

RESET: "Reset Budget" {
  style: { fill: "#e0e0e0"; stroke: "#616161"; border-radius: 6; font-size: 14 }
}

AFFECT: "Update Affect\n(from prior cycle metrics)" {
  style: { fill: "#e1bee7"; stroke: "#8e24aa"; border-radius: 6; font-size: 14 }
}

THREAT: "Assess Threats\n(homeostatic monitor)" {
  style: { fill: "#fff3e0"; stroke: "#ef6c00"; border-radius: 6; font-size: 14 }
}

ANXIETY: "Inject Survival Anxiety\n(affect ‚Üê threat)" {
  style: { fill: "#e1bee7"; stroke: "#8e24aa"; border-radius: 6; font-size: 14 }
}

SGOAL: "Generate Survival Goals\n(if threats detected)" {
  style: { fill: "#ffcdd2"; stroke: "#e53935"; border-radius: 6; font-size: 14 }
}

L0CHECK: "Layer 0\nCheck" {
  shape: diamond
  style: { fill: "#ffcdd2"; stroke: "#c62828"; border-radius: 6; stroke-width: 2; font-size: 14 }
}

REJECT: "Reject Goal" {
  style: { fill: "#ef9a9a"; stroke: "#b71c1c"; border-radius: 6; font-size: 14 }
}

MOTIV: "Synthesize Motivation\n(drives from affect)" {
  style: { fill: "#e1bee7"; stroke: "#8e24aa"; border-radius: 6; font-size: 14 }
}

GWS: "Broadcast Global\nWorkspace Snapshot" {
  style: { fill: "#e0e0e0"; stroke: "#616161"; border-radius: 6; font-size: 14 }
}

PREDICT: "1. PREDICT\n(PredictionEngine)" {
  style: { fill: "#fff9c4"; stroke: "#f9a825"; border-radius: 8; shadow: true; stroke-width: 2; font-size: 15 }
}

ACT: "2. ACT\n(LLM Execute)" {
  style: { fill: "#c8e6c9"; stroke: "#2e7d32"; border-radius: 8; shadow: true; stroke-width: 2; font-size: 15 }
}

COMPARE: "3. COMPARE\n(MetaCognition)" {
  style: { fill: "#fff9c4"; stroke: "#f9a825"; border-radius: 8; shadow: true; stroke-width: 2; font-size: 15 }
}

GUARD: "4. ESCALATION\nGUARD" {
  shape: diamond
  style: { fill: "#ffcdd2"; stroke: "#c62828"; border-radius: 6; font-size: 14 }
}

COOLDOWN: "30s Cooldown" {
  style: { fill: "#e0e0e0"; stroke: "#616161"; border-radius: 6; font-size: 14 }
}

NEXT: "‚Üí Part 2: Convergence & Self-Update" {
  style: { fill: "#f5f5f5"; stroke: "#9e9e9e"; border-radius: 6; font-size: 13; italic: true }
}

# Pre-loop flow
START -> RESET: { style.animated: true }
RESET -> AFFECT: { style.animated: true }
AFFECT -> THREAT: { style.animated: true }
THREAT -> ANXIETY: { style.animated: true }
ANXIETY -> SGOAL: { style.animated: true }
SGOAL -> L0CHECK: { style.animated: true }
L0CHECK -> MOTIV: "pass" { style.animated: true; style.stroke: "#4caf50" }
L0CHECK -> REJECT: "‚ùå violation" { style.stroke: "#c62828"; style.stroke-dash: 5 }
REJECT -> MOTIV: { style.stroke-dash: 5 }
MOTIV -> GWS: { style.animated: true }

# Core loop
GWS -> PREDICT: { style.animated: true; style.stroke: "#f9a825"; style.stroke-width: 3 }
PREDICT -> ACT: { style.animated: true; style.stroke: "#2e7d32"; style.stroke-width: 3 }
ACT -> COMPARE: { style.animated: true; style.stroke: "#f9a825"; style.stroke-width: 3 }
COMPARE -> GUARD: { style.animated: true; style.stroke: "#c62828"; style.stroke-width: 2 }
GUARD -> NEXT: "safe ‚úÖ" { style.animated: true; style.stroke: "#4caf50" }
GUARD -> COOLDOWN: "‚ö†Ô∏è limit" { style.stroke: "#c62828"; style.stroke-dash: 5 }
